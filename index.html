<script>
    const directoryUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRR4JXxJLCTe_P6-il5qzS-oKP8gU_1jYkCHGHH0tYVoejVgMXl3CGifcgC603ZiVLOAl53zL_u9P83/pub?gid=1696549759&single=true&output=csv';
    const synonymsUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRR4JXxJLCTe_P6-il5qzS-oKP8gU_1jYkCHGHH0tYVoejVgMXl3CGifcgC603ZiVLOAl53zL_u9P83/pub?gid=1225631162&single=true&output=csv';
    
    // The script will now look for these KEYWORDS within your category names
    const smsKeywords = ['radiologist', 'physician', 'nurse', 'provider', 'pa', 'np'];

    let fullData = [];
    let officialLookup = {}; 
    let synonymStrings = {}; 
    let currentCategory = "All";

    function cleanStr(str) {
        return str ? str.toLowerCase().replace(/[^a-z0-9]/g, '').trim() : "";
    }

    async function init() {
        try {
            const synResp = await fetch(synonymsUrl);
            const synText = await synResp.text();
            const synRows = synText.split(/\r?\n/).filter(line => line.trim().length > 0);
            
            synRows.forEach(row => {
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if(cols.length > 0) {
                    const official = cols[0].replace(/^"|"$/g, '').trim();
                    synonymStrings[official] = cols.join(' ').toLowerCase();
                    cols.forEach(variant => {
                        const variantClean = cleanStr(variant);
                        if(variantClean) officialLookup[variantClean] = official;
                    });
                }
            });

            const resp = await fetch(directoryUrl);
            const text = await resp.text();
            const rows = text.split(/\r?\n/).filter(line => line.trim().length > 0).slice(1); 
            
            fullData = rows.map(row => {
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const rawLoc = cols[1]?.replace(/^"|"$/g, '').trim() || "Unknown";
                const officialLoc = officialLookup[cleanStr(rawLoc)] || rawLoc;

                return {
                    cat: cols[0]?.replace(/^"|"$/g, '').trim() || "Other",
                    loc: officialLoc, 
                    name: cols[2]?.replace(/^"|"$/g, '').trim() || "---",
                    phone: cols[3]?.replace(/^"|"$/g, '').trim() || "",
                    email: cols[4]?.replace(/^"|"$/g, '').trim() || ""
                };
            }).filter(item => item.phone !== "" || item.email !== "");

            renderTabs();
            renderDirectory();
        } catch (e) { 
            document.getElementById('loading').innerText = "Load Error. Please refresh."; 
        }
    }

    function renderDirectory() {
        const container = document.getElementById('directory');
        container.innerHTML = '';
        const filtered = currentCategory === "All" ? fullData : fullData.filter(d => d.cat === currentCategory);
        const grouped = {};
        
        filtered.forEach(d => {
            if (!grouped[d.loc]) grouped[d.loc] = [];
            grouped[d.loc].push(d);
        });

        const sortedLocs = Object.keys(grouped).sort();
        sortedLocs.forEach(loc => {
            const section = document.createElement('div');
            section.className = 'location-section';
            const header = document.createElement('div');
            header.className = 'location-header';
            header.innerHTML = `<span>${loc}</span><span class="chevron"></span>`;
            header.onclick = () => toggle(header);

            const content = document.createElement('div');
            content.className = 'location-content';

            grouped[loc].sort((a,b) => a.name.localeCompare(b.name)).forEach(c => {
                const dial = c.phone.replace(/\D/g, '');
                const extraSyns = synonymStrings[c.loc] || "";
                const row = document.createElement('div');
                row.className = 'contact-row';
                row.setAttribute('data-search', `${c.loc} ${c.name} ${c.email} ${c.phone} ${extraSyns}`.toLowerCase());
                
                const emailHtml = c.email 
                    ? `<a href="mailto:${c.email}" class="action-icon email-btn" title="Email ${c.name}">âœ‰</a>` 
                    : `<div style="width:36px"></div>`;
                
                // BROAD MATCH LOGIC: Check if any keyword exists in the category name
                const catLower = c.cat.toLowerCase();
                const showSms = smsKeywords.some(keyword => catLower.includes(keyword));
                
                const smsHtml = (c.phone && showSms) 
                    ? `<a href="sms:${dial}" class="action-icon sms-btn" title="Text ${c.phone}">ðŸ’¬</a>` 
                    : `<div style="width:36px"></div>`;

                row.innerHTML = `<span class="display-text">${c.name}</span><div class="actions-cell"><a href="tel:${dial}" class="phone-link">${c.phone}</a>${smsHtml}${emailHtml}</div>`;
                content.appendChild(row);
            });
            section.appendChild(header);
            section.appendChild(content);
            container.appendChild(section);
        });
    }
    // ... [Remainder of code same as previous version]
</script>
